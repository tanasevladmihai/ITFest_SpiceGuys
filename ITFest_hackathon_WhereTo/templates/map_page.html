<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ category.name }} in {{ city.name }}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}"></script>
    <style>
        .location-highlight { font-weight: bold; color: #00796b; font-size: 1.2em; }
        .modal { display: none; position: fixed; top: 20%; left: 20%; width: 60%; background: white; padding: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1000; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="head-title">Discover {{ category.name }} in {{ city.name }}</h1>
    </div>
    <div class="container">
        <div class="left-panel" id="event-list"></div>
        <div class="right-panel">
            <div id="map"></div>
        </div>
    </div>
    <div class="modal-overlay" id="modal-overlay"></div>
    <div class="modal" id="modal">
        <h2 id="modal-title"></h2>
        <p id="modal-description"></p>
        <button onclick="closeModal()">Close</button>
    </div>

    <script>
        let map, marker;
        const cityId = {{ city.id }}, categoryId = {{ category.id }};

        function initMap(lat = 0, lng = 0) {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: lat, lng: lng },
                zoom: 12
            });
            marker = new google.maps.Marker({ map: map });
        }

        function updateMap(lat, lng) {
            const position = { lat: lat, lng: lng };
            map.setCenter(position);
            marker.setPosition(position);
        }

        function showModal(name, description) {
            document.getElementById('modal-title').textContent = name;
            document.getElementById('modal-description').textContent = description;
            document.getElementById('modal').style.display = 'block';
            document.getElementById('modal-overlay').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function loadEvents(position) {
            const url = `/api/events/${cityId}/${categoryId}/?location=${position.coords.longitude},${position.coords.latitude}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const eventList = document.getElementById('event-list');
                    eventList.innerHTML = '';
                    if (data.events.length > 0) {
                        data.events.forEach((event, index) => {
                            const div = document.createElement('div');
                            div.className = index === 0 ? 'active-event' : 'passive-event';
                            div.innerHTML = `
                                <h3>${event.name}</h3>
                                <p>Theme: ${event.theme}</p>
                                <p>Distance: ${event.distance ? event.distance.toFixed(2) + ' km' : 'N/A'}</p>
                                <p class="location-highlight">Location: ${event.address}</p>
                                <p>Starts: ${new Date(event.start_date).toLocaleString()}</p>
                                <p>Ends: ${new Date(event.end_date).toLocaleString()}</p>
                                <button onclick="showModal('${event.name}', '${event.description.replace(/'/g, "\\'")}')">More</button>
                            `;
                            div.onclick = () => updateMap(event.location.coordinates[1], event.location.coordinates[0]);
                            eventList.appendChild(div);
                            if (index === 0) updateMap(event.location.coordinates[1], event.location.coordinates[0]);
                        });
                    } else {
                        eventList.innerHTML = '<p>No upcoming events.</p>';
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        navigator.geolocation.getCurrentPosition(
            position => {
                initMap(position.coords.latitude, position.coords.longitude);
                loadEvents(position);
            },
            error => {
                initMap();
                loadEvents({ coords: { longitude: 0, latitude: 0 } });
                alert('Location access denied. Using default sorting.');
            }
        );
    </script>
</body>
</html>